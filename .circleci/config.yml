aliases:
  - &build_environment
    working_directory: ~/data
    executor: build-executor

  - &attach_workspace
    attach_workspace:
      at: ~/data

  - &repo-defaults
    repo: circleci-test-cluster
    tag: "${CIRCLE_SHA1}"

  - &props-image-sha1
    <<: *repo-defaults
    tag: "${CIRCLE_SHA1}"

  - &props-image-tag
    <<: *repo-defaults
    tag: << parameters.tag >>

  - &props-shared-parameters
    production:
      type: boolean
      default: false
    tag:
      type: string
      default: "latest"

  - &build_steps
    - aws-cli/install
    - aws-cli/configure
    - aws-ecr/ecr-login
    - checkout
    - unless:
        condition: << parameters.production >>
        steps:
          - aws-ecr/build-image:
              <<: *props-image-sha1
          - aws-ecr/push-image:
              <<: *props-image-sha1
          - aws-ecr/build-image:
              <<: *props-image-tag
          - aws-ecr/push-image:
              <<: *props-image-tag
    - when:
        condition: << parameters.production >>
        steps:
          - aws-ecr/build-image:
              <<: *props-image-tag
              tag: "$(cat VERSION.txt)"
          - aws-ecr/push-image:
              <<: *props-image-tag
              tag: "$(cat VERSION.txt)"

  - &deploy_helm_chart_steps
    - checkout
    - run:
        command: |
          mkdir ~/.kube/ && \
          echo $KUBECONFIG_BASE64 | base64 -d | xargs -0 echo > ~/.kube/config
    - helm/install-helm-client:
        version: "v2.11.0"
    - when:
        condition: << parameters.production >>
        steps:
          - helm/install-helm-chart:
              values-to-override: "image.tag=${CIRCLE_SHA1}"
              chart: .helm/
              release-name: app
    - unless:
        condition: << parameters.production >>
        steps:
          - helm/install-helm-chart:
              values-to-override: "image.tag=$(cat VERSION.txt)"
              chart: .helm/
              release-name: app

  - &prod_filters
    branches:
      only:
        - master

  - &stage_filters
    branches:
      only:
        - migrate-to-circleci

version: 2.1
orbs:
  aws-cli: circleci/aws-cli@0.1.13
  aws-ecr: circleci/aws-ecr@6.1.0
  helm: circleci/helm@0.1.2
executors:
  build-executor:
    machine: true

workflows:
  version: 2
  master:
    jobs:
      - "Build docker image":
          name: "Build staging image"
          production: false
          filters:
            <<: *stage_filters
      - "Build docker image":
          name: "Build production image"
          production: true
          filters:
            <<: *prod_filters
      - "Deploy helm charts":
          name: "Deploy staging chart"
          requires:
            - "Build staging image"
          filters:
            <<: *stage_filters
      - "Deploy helm charts":
          name: "Deploy production chart"
          requires:
            - "Build production image"
          filters:
            <<: *prod_filters

jobs:
  "Build docker image":
    <<: *build_environment
    parameters: *props-shared-parameters
    steps: *build_steps
  "Deploy helm charts":
    <<: *build_environment
    parameters: *props-shared-parameters
    steps: *deploy_helm_chart_steps
