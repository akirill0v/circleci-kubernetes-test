aliases:
  - &build_environment
    working_directory: ~/data
    executor: build-executor

  - &attach_workspace
    attach_workspace:
      at: ~/data

  - &repo-defaults
    repo: circleci-test-cluster
    tag: "${CIRCLE_SHA1}"

  - &props-image-sha1
    <<: *repo-defaults
    tag: "${CIRCLE_SHA1}"

  - &props-image-tag
    <<: *repo-defaults
    tag: << parameters.tag >>

  - &build_steps
    - aws-cli/install
    - aws-cli/configure
    - aws-ecr/ecr-login
    - checkout
    - unless:
        condition: << parameters.production >>
        steps:
          - aws-ecr/build-image:
              <<: *props-image-sha1
          - aws-ecr/push-image:
              <<: *props-image-sha1
          - aws-ecr/build-image:
              <<: *props-image-tag
          - aws-ecr/push-image:
              <<: *props-image-tag
    - when:
        condition: << parameters.production >>
        steps:
          - aws-ecr/build-image:
              <<: *props-image-tag
              tag: "$(cat VERSION.txt)"
          - aws-ecr/push-image:
              <<: *props-image-tag
              tag: "$(cat VERSION.txt)"

  - &prod_filters
    branches:
      only:
        - master

  - &stage_filters
    branches:
      only:
        - migrate-to-circleci

version: 2.1
orbs:
  aws-cli: circleci/aws-cli@0.1.13
  aws-ecr: circleci/aws-ecr@6.1.0
executors:
  build-executor:
    machine: true

workflows:
  version: 2
  master:
    jobs:
      - "Build docker image":
          production: false
          filters:
            <<: *stage_filters
      - "Build docker image":
          production: true
          filters:
            <<: *prod_filters

jobs:
  "Build docker image":
    <<: *build_environment
    parameters:
      production:
        type: boolean
        default: false
      tag:
        type: string
        default: "latest"
    steps: *build_steps
